---
title: "parse_pages"
date: '2022-05-30'
---

```{r}
library(tidyverse)
library(pdftools)
library(anytime)
library(reticulate)
source_python("functions.py")
source("~/Projects/nixon-diary-extraction/functions.R")
```

```{r}
raw.1969 <- read_rds("1969.rds")
raw.1970 <- read_rds("1970.rds")
raw.1971 <- read_rds("1971.rds")
raw.1972 <- read_rds("1972.rds")
raw.1973 <- read_rds("1973.rds")
raw.1974 <- read_rds("1974.rds")
```

Appendix pages are incredibly nonstandard. Extracting data from those manually doesn't seem doable.


```{r}
toc_1969 <- build_toc("1969 Presidential Daily Diary.pdf")
toc_1970 <- build_toc("1970 Presidential Daily Diary.pdf")
toc_1971 <- build_toc("1971 Presidential Daily Diary.pdf")
toc_1972 <- build_toc("1972 Presidential Daily Diary.pdf")
toc_1973 <- build_toc("1973 Presidential Daily Diary.pdf")
toc_1974 <- build_toc("1974 Presidential Daily Diary.pdf")
```


```{r}
diary.1969 <- create.doc.lists(raw.1969, toc_1969)
diary.1970 <- create.doc.lists(raw.1970, toc_1970)
diary.1971 <- create.doc.lists(raw.1971, toc_1971)
diary.1972 <- create.doc.lists(raw.1972, toc_1972)
diary.1973 <- create.doc.lists(raw.1973, toc_1973)
diary.1974 <- create.doc.lists(raw.1974, toc_1974)
```

The colon is sometimes recognized as a 3. Also sometimes "10:xx" becomes "0:xx". Write time validation function after processing. There's 1 - 3 characters between times. Also

```{r}
test <- diary.1971$`April 17, 1971`$pages[2]
test_split <- str_split(test, '\\n')[[1]]
time_pattern <- '[:digit:]{1,2}[:graph:]+[:digit:]{2}'
call_pattern <- '(?<=[:blank:]|[:symbol:]|[:punct:])(P|R)(?=[:blank:]|[:symbol:]|[:punct:])'
str_extract_all(test_split[38], time_pattern)
str_extract_all(test_split[24], call_pattern)
```



```{r}
build_data_frame <- function(date, pages) {
  date_df <- as.matrix(data.frame(date = character(),
                        time_in = character(),
                        time_out = character(),
                        phone = character(),
                        activity = character()
                        ))
  for (page in pages) {
    page_split <- str_split(page, '\\n')[[1]]
    #find start of diary entries to avoid time in title of page
    start <- 1
    while (!str_starts(time_pattern, line[start])) {
      start <- start + 1
    }
    #Extract times, phone, activity
    for (line in page[start:length(page)]) {
      times <- str_extract_all(line, time_pattern)
      #start new entry
      if (!identical(times, character(0))) {
        phone <- str_extract(line, call_pattern)
        #Find activity start
        if (!identical(phone, character(0))) {
          activity <- str_sub(line, str_locate(line, call_pattern)[,'end'] + 1)
        }
        else {
          
        }
      }
      #append to previous entry
      else{
        
      }
    }
  }
}
```

Steps:
Find the first line item (str_starts)
get time, P|R, rest of text
while next line not new item, append


TODO:
Store whole dataframe in diary object
Write Time validation logic 